<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>MUDç»ˆç«¯</title>
  <style>
    body { background: #111; color: #0f0; font-family: "Consolas", monospace; margin:0;padding:0;}
    #output { padding:20px; min-height:70vh; max-height:80vh; overflow-y:auto;}
    #input-line { display:flex; align-items:center; padding:10px;}
    #prompt { margin-right:10px;}
    #cmdInput {
      background:#000;color:#0f0;border:none;font-family:"Consolas",monospace;font-size:16px;
      width:90vw;min-height:22px;max-height:80px;
      outline:none;padding:.2em .6em;border-radius:.3em;
      caret-color:#00ff00;
      word-break:break-all;
    }
    #cmdInput:focus { outline:none;}
    ::-webkit-scrollbar-thumb{background:#00ff00;}
  </style>
</head>
<body>
<div id="output">æ­£åœ¨åŠ è½½ä¸–ç•Œæ•°æ®...</div>
<div id="input-line" style="display:none;">
  <span id="prompt">&gt;</span>
  <div id="cmdInput" contenteditable="true"></div>
</div>
<script src="js-yaml.min.js"></script>
<script>
// ========== è”ç½‘/æœ¬åœ°æ¨¡å¼è‡ªåŠ¨æ£€æµ‹ ==========
let ONLINE_MODE = false;
let SERVER_URL = "http://127.0.0.1:3000/api/ping"; // æ”¹æˆä½ çš„çœŸå®åç«¯å¥åº·æ£€æŸ¥æ¥å£

async function checkServerOnline() {
    try {
        let resp = await fetch(SERVER_URL, {method:'GET',cache:'no-store'});
        if(resp.ok) return true;
    } catch(e){}
    return false;
}

// ================= å·¥å…·å‡½æ•° ==================
function showMsg(msg, cls='info') {
    const output = document.getElementById('output');
    const el = document.createElement('div');
    el.style.color = {info:'#0f0',warn:'#ff0',error:'#f55',event:'#7fffd4',success:'#39f691'}[cls]||'#fff';
    el.innerHTML = msg.replace(/\n/g, '<br>');
    output.appendChild(el);
    output.scrollTop = output.scrollHeight;
}
function clearScreen() {
    document.getElementById('output').innerHTML = '';
}
// ========== åŠ¨æ€åŠ è½½æ‰€æœ‰ YAML åŒºåŸŸ ==========
async function loadAllAreas() {
  let fileList;
  try {
      const indexResp = await fetch('quyu/index.json');
      fileList = await indexResp.json();
      if (!Array.isArray(fileList)) throw 'index.jsonæ ¼å¼é”™è¯¯';
  } catch(e) {
      showMsg('æ— æ³•åŠ è½½quyu/index.jsonï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ã€‚','error');
      return null;
  }

  let allAreas = {};
  let allRooms = {};
  for (let fname of fileList) {
      try {
          let resp = await fetch('quyu/' + fname);
          let ymlText = await resp.text();
          let areaObj = jsyaml.load(ymlText);
          if(areaObj && areaObj.area_id) {
              allAreas[areaObj.area_id] = areaObj;
              // åˆå¹¶æ‰€æœ‰æˆ¿é—´åˆ°å…¨å±€roomså­—å…¸
              if(Array.isArray(areaObj.rooms)){
                for(let r of areaObj.rooms){
                  allRooms[r.id] = {...r, area_id: areaObj.area_id, area_name: areaObj.name};
                }
              }
          }
      } catch(e) {
          showMsg(`åŠ è½½${fname}å¤±è´¥ï¼`,'warn');
      }
  }
  return {areas:allAreas, rooms:allRooms};
}

// ========= åŠ¨æ€åŠ è½½å¤–éƒ¨å‘½ä»¤ ==========
async function loadAllCommands() {
  let cmdList;
  try {
      const resp = await fetch('quyu/commands/index.json');
      cmdList = await resp.json();
      if (!Array.isArray(cmdList)) throw 'commands/index.jsonæ ¼å¼é”™è¯¯';
  } catch(e) {
      showMsg('æ— æ³•åŠ è½½quyu/commands/index.jsonï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ã€‚','error');
      return [];
  }

  for (let fname of cmdList) {
      await new Promise((resolve,reject)=>{
          const s=document.createElement('script');
          s.src='quyu/commands/'+fname;
          s.onload=resolve; s.onerror=()=>{showMsg(fname+" åŠ è½½å¤±è´¥","warn");resolve();};
          document.body.appendChild(s);
      });
  }
}

// =================== æ¸¸æˆä¸»é€»è¾‘ ===================
window.MUD_COMMANDS={}; // å…¨å±€å‘½ä»¤æ³¨å†Œè¡¨
let needName = true;
let GAME={
   areas:{},
   rooms:{},
   player:{
     name:'å†’é™©è€…',
     location:null,
     inventory:['é‡‘å¸'],
     health:30,
     maxHealth:30,
   },
   showMsg : showMsg,
   clearScreen : clearScreen,
};

let loginUser = localStorage.getItem('mud_user') || null;
let needLogin = !loginUser;

// æœ¬åœ°å­˜æ¡£ç›¸å…³
function getAllUsers() {
    let users = localStorage.getItem('mud_users');
    return users ? JSON.parse(users) : {};
}
function saveAllUsers(users) {
    localStorage.setItem('mud_users', JSON.stringify(users));
}
function saveCurrentPlayer() {
    let users = getAllUsers();
    users[GAME.player.name] = {...GAME.player};
    saveAllUsers(users);
}

async function handleCommand(cmd){
    cmd = cmd.trim();
    if(!cmd) return;

    setTimeout(()=>{
        let c=document.getElementById('cmdInput');
        c.innerHTML='';
        c.focus();
    },10);

    showMsg("> "+cmd,"event");

    let args = cmd.split(/\s+/), verb = args[0].toLowerCase(), argStr = args.slice(1).join(' ').trim();

    // ç™»å½•æˆ–è½½å…¥æµç¨‹
    if (needLogin && !["login", "load"].includes(verb)) {
        showMsg("è¯·å…ˆ login ç”¨æˆ·å æˆ– load å­˜æ¡£ï¼", "warn");
        return;
    }

    // ----------- ç™»å½•å‘½ä»¤ï¼ˆè‡ªåŠ¨åˆ‡æ¢æœ¬åœ°/äº‘ç«¯ï¼‰-----------
    if (verb === "login") {
        const username = argStr;
        if(!username) {
            showMsg("ç”¨æ³•ï¼šlogin ç”¨æˆ·å", "warn");
            return;
        }
        if (ONLINE_MODE) {
            // è”ç½‘ç™»å½•
            try {
                let resp = await fetch('/api/login', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({username})
                });
                let data = await resp.json();
                if(data.player){
                    GAME.player = data.player;
                    loginUser = username;
                    needLogin = false;
                    localStorage.setItem('mud_user', username); // ä¿å­˜å½“å‰ç”¨æˆ·å
                    showMsg(`æ¬¢è¿ä½ , <b>${GAME.player.name}</b>!`, "success");
                    // è‡ªåŠ¨è¿›å…¥åˆå§‹æˆ¿é—´
                    if(!GAME.player.location){
                        GAME.player.location = Object.keys(GAME.rooms)[0];
                    }
                    if(window.MUD_COMMANDS.look) window.MUD_COMMANDS.look([], GAME);
                } else {
                    showMsg(data.error||"ç™»å½•å¤±è´¥", "error");
                }
            } catch(e){
                showMsg("æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼å·²åˆ‡æ¢åˆ°æœ¬åœ°æ¸¸ç©æ¨¡å¼ã€‚", "error");
                ONLINE_MODE=false; // åŠ¨æ€é™çº§
            }
            return;
        } else {
            // æœ¬åœ°ç™»å½•
            let users=getAllUsers();
            if(users[username]){
                GAME.player={...users[username]};
                loginUser=username; needLogin=false;
                localStorage.setItem('mud_user', username);
                showMsg(`æ¬¢è¿ä½ , <b>${GAME.player.name}</b>!`, "success");
            }else{
                GAME.player={name:username,location:Object.keys(GAME.rooms)[0],inventory:['é‡‘å¸'],health:30,maxHealth:30};
                loginUser=username; needLogin=false;
                localStorage.setItem('mud_user', username);
                saveCurrentPlayer();
                showMsg(`æ–°è§’è‰²å·²åˆ›å»ºï¼š<b>${GAME.player.name}</b>`, "success");
            }
            if(window.MUD_COMMANDS.look) window.MUD_COMMANDS.look([], GAME);
            return;
        }
    }

    // ----------- å­˜æ¡£ä¿å­˜å‘½ä»¤ ----------
    if(verb === "save"){
        if(ONLINE_MODE){
            try{
               await fetch('/api/save',{
                   method:'POST',
                   headers:{'Content-Type':'application/json'},
                   body:JSON.stringify({player:GAME.player})
               });
               showMsg("äº‘ç«¯å­˜æ¡£æˆåŠŸï¼","success");
            }catch(e){
               showMsg("äº‘ç«¯å­˜æ¡£å¤±è´¥ï¼Œå·²åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼","warn");
               ONLINE_MODE=false;//é™çº§ä¸ºæœ¬åœ°
               saveCurrentPlayer(); 
               showMsg("å·²ä¿å­˜åˆ°æœ¬åœ°ï¼","success");
            }
        }else{
           saveCurrentPlayer();
           showMsg("å·²ä¿å­˜åˆ°æœ¬åœ°ï¼","success");
        }
        return;
     }

     // ----------- æœ¬åœ°è½½å…¥å‘½ä»¤ ----------
     if(verb==="load"){
         let users=getAllUsers();
         if(loginUser && users[loginUser]){
             GAME.player={...users[loginUser]};
             needLogin=false;
             showMsg("æœ¬åœ°å­˜æ¡£å·²è½½å…¥ï¼š"+loginUser,"success");
             if(window.MUD_COMMANDS.look)
                 window.MUD_COMMANDS.look([], GAME);
         }else{
             showMsg("æ²¡æœ‰å¯ç”¨çš„æœ¬åœ°å­˜æ¡£","warn");
         }
         return;
     }

     // ç™»å‡ºåŠŸèƒ½
     if (verb === "logout") {
         loginUser=null; needLogin=true; 
         GAME.player={};
         localStorage.removeItem('mud_user');
         showMsg("ä½ å·²é€€å‡ºç™»å½•ï¼Œè¯·é‡æ–° login ç”¨æˆ·å", "warn");
         return;
     }

     // å‘½ä»¤åˆ†å‘ï¼ˆå¤–éƒ¨å‘½ä»¤ä¼˜å…ˆï¼‰
     if(window.MUD_COMMANDS && typeof window.MUD_COMMANDS[verb]==='function'){
         await window.MUD_COMMANDS[verb](args, GAME);
         return;
     }

     // help/help/h å†…ç½®å¸®åŠ©
     if(['help','h'].includes(verb)){
          [
          "ä¸»è¦å‘½ä»¤:",
             "look/l           - æŸ¥çœ‹å½“å‰æˆ¿é—´",
             "go/move [æ–¹å‘] æˆ– north/east... - ç§»åŠ¨",
             "get/take [åç§°]                 - æ‹¾å–æˆ¿é—´å†…æŸä¸ªé“å…·",
             "drop [åç§°]                     - ä¸¢å¼ƒèƒŒåŒ…é‡Œçš„æŸä¸ªé“å…·",
             "inventory/i                     - æŸ¥çœ‹èƒŒåŒ…",
             "name [åå­—]                      - è®¾ç½®ä½ çš„è§’è‰²å",
             "login [åå­—]                     - ç™»å½•æ¸¸æˆ",
             "logout                           - ç™»å‡ºæ¸¸æˆ",
             "save                             - ä¿å­˜æ¸¸æˆ",
             "load                             - åŠ è½½æ¸¸æˆ",
             "help/h                           - æ˜¾ç¤ºå¸®åŠ©"
          ].forEach(s=>showMsg(s,"info"));
          return;
     }

     showMsg("æ— æ³•è¯†åˆ«çš„æŒ‡ä»¤ï¼š"+cmd,'warn');
}

// =================== åˆå§‹åŒ–æµç¨‹ ===================
(async function main(){
 document.getElementById('output').innerHTML='æ­£åœ¨æ£€æµ‹æœåŠ¡å™¨çŠ¶æ€...';

 ONLINE_MODE=await checkServerOnline();

 document.getElementById('output').innerHTML=(ONLINE_MODE ? 
   "<span style='color:#39f691'>ğŸŒ å·²è¿æ¥æœåŠ¡å™¨ï¼Œè”ç½‘æ¨¡å¼</span>" :
   "<span style='color:#ff0'>ğŸ’» æœªè¿æ¥æœåŠ¡å™¨ï¼Œæœ¬åœ°æ¸¸ç©æ¨¡å¼</span>"
 );

 const data=await loadAllAreas();
 if(!data){return;}

 GAME.areas=data.areas; 
 GAME.rooms=data.rooms;

 // é»˜è®¤è¿›å…¥ç¬¬ä¸€ä¸ªåŒºåŸŸç¬¬ä¸€ä¸ªæˆ¿é—´
 let firstRoomId=null;
 for(let aid in data.areas){
   let a=data.areas[aid];
   if(Array.isArray(a.rooms)&&a.rooms.length>0){
       firstRoomId=a.rooms[0].id; break;
   }
 }
 GAME.player.location=firstRoomId;

 clearScreen();

if(needLogin){
   showMsg("=========================================","info");
   showMsg(" ğŸ¡ æ¬¢è¿æ¥åˆ°MUDç»ˆç«¯ ","info");
   showMsg("<b>è¯·å…ˆè¾“å…¥ï¼š</b> login ç”¨æˆ·å æˆ– load å­˜æ¡£", "info");
   showMsg((ONLINE_MODE?"<b>å½“å‰ä¸ºè”ç½‘æ¨¡å¼ï¼Œå¯äº‘ç«¯åŒæ­¥è§’è‰²ã€‚</b>":"<b>å½“å‰ä¸ºæœ¬åœ°ç¦»çº¿æ¨¡å¼ï¼Œä»…åœ¨æµè§ˆå™¨ä¿å­˜ã€‚</b>"),"info")
   showMsg("=========================================","info");
} else{
   showMsg("=========================================","info");
   showMsg(" ğŸ¡ æ¬¢è¿å›æ¥, <b>"+loginUser+"</b>ï¼","info");
   showMsg((ONLINE_MODE?"<b>å½“å‰ä¸ºè”ç½‘æ¨¡å¼ï¼Œå¯äº‘ç«¯åŒæ­¥è§’è‰²ã€‚</b>":"<b>å½“å‰ä¸ºæœ¬åœ°ç¦»çº¿æ¨¡å¼ï¼Œä»…åœ¨æµè§ˆå™¨ä¿å­˜ã€‚</b>"),"info")
   showMsg("=========================================","info");
}

 await loadAllCommands();

 setTimeout(()=>{
   document.getElementById('input-line').style.display='';
   const cmdInput=document.getElementById('cmdInput');
   cmdInput.addEventListener('keydown', function(e) {
         if(e.key==="Enter"){
             e.preventDefault();
             let cmd=(this.textContent||this.innerText).trim();
             handleCommand(cmd);
         }
   });
   document.body.addEventListener('click',()=>cmdInput.focus());
   cmdInput.focus();
 },200);

 // è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡lookï¼Œæ˜¾ç¤ºåˆå§‹æˆ¿é—´ä¿¡æ¯ï¼ˆå¦‚æœæœ‰lookå‘½ä»¤ï¼‰
 if(window.MUD_COMMANDS.look)
     window.MUD_COMMANDS.look([], GAME);

})();
</script>
</body>
</html>